<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Work-wise Table — Shared (Google Sheets)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa3b2;--accent:#0ea5a6;--accent-2:#7c3aed}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;background:linear-gradient(180deg,#071226 0%, #071a2b 100%);color:#e6eef6;min-height:100vh;padding:28px}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:10px;align-items:center}
    .controls input[type=text], .controls select{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .card{background:rgba(255,255,255,0.02);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.5)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
    th{cursor:pointer;user-select:none}
    tr:hover td{background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .tag.open{background:rgba(14,165,166,0.12);color:var(--accent)}
    .tag.progress{background:rgba(124,58,237,0.12);color:var(--accent-2)}
    .tag.done{background:rgba(34,197,94,0.12);color:#22c55e}
    .actions button{margin-right:6px;padding:6px 8px;border-radius:8px;border:none;background:rgba(255,255,255,0.02);color:inherit;cursor:pointer}
    .small{font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .progressbar{height:8px;background:rgba(255,255,255,0.04);border-radius:6px;overflow:hidden;width:120px}
    .progress-inner{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));}
    /* responsive */
    @media (max-width:800px){
      table thead{display:none}
      table,tbody,tr,td{display:block;width:100%}
      tr{margin-bottom:12px}
      td{padding:10px;border-bottom:0;background:rgba(255,255,255,0.02)}
      td:before{content:attr(data-label);display:block;font-weight:600;color:var(--muted);margin-bottom:6px}
    }

    /* Modal */
    #formWrap{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center;z-index:60}
    #formBox{background:var(--card);padding:18px;border-radius:12px;min-width:320px;max-width:640px;margin:auto}
    #formBox h3{margin:0 0 8px 0}
    #formBox .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
    #formBox input,#formBox select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Work-wise Table (Shared)</h1>
      <div class="controls">
        <input id="search" type="text" placeholder="Search tasks, assignee or notes" />
        <select id="filterStatus">
          <option value="all">All status</option>
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Done">Done</option>
        </select>
        <button class="btn" id="addBtn">+ Add Task</button>
        <button class="btn ghost" id="refreshBtn">Refresh</button>
      </div>
    </header>

    <section class="card">
      <div class="small">Shared database: all users see the same data. Changes sync every 5s (or press Refresh).</div>

      <table id="workTable" aria-label="Work wise table">
        <thead>
          <tr>
            <th data-key="srNo">Sr.No.</th>
            <th data-key="task">Task</th>
            <th data-key="assignee">Assignee</th>
            <th data-key="priority">Priority</th>
            <th data-key="status">Status</th>
            <th data-key="start">Start</th>
            <th data-key="end">End</th>
            <th data-key="hrs">Est Hrs</th>
            <th data-key="prog">Progress</th>
            <th data-key="file">File</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </section>
  </div>

  <!-- hidden form -->
  <div id="formWrap">
    <div id="formBox">
      <h3 id="formTitle">Add Task</h3>
      <div class="row">
        <input id="fTask" placeholder="Task title" />
        <input id="fAssignee" placeholder="Assignee" />
      </div>
      <div class="row">
        <select id="fPriority"><option>Low</option><option>Medium</option><option>High</option></select>
        <select id="fStatus"><option>Open</option><option>In Progress</option><option>Done</option></select>
      </div>
      <div class="row">
        <input id="fStart" type="date" />
        <input id="fEnd" type="date" />
      </div>
      <div class="row">
        <input id="fHrs" placeholder="Estimated hours" type="number" />
        <input id="fProg" placeholder="Progress %" type="number" max="100" min="0" />
      </div>

      <!-- optional file input for attaching a file to a task -->
      <div style="margin-bottom:8px">
        <label class="small">Attach file (optional)</label><br>
        <input id="taskFileInput" type="file" />
      </div>

      <div style="text-align:right">
        <button id="cancelForm" style="margin-right:8px;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent">Cancel</button>
        <button id="saveForm" class="btn">Save</button>
      </div>
    </div>
  </div>

  <script>
    // ********* CONFIG *********
    const API_URL = "https://script.google.com/macros/s/AKfycbxeQtXbnghWf8YYrY3ytShl_SLqI_XDmfwBgIWro2l81soPo-1OBFYeJRdVWcmDwMYu/exec";
    // polling interval (ms)
    const POLL_MS = 5000;

    // ********* small helpers *********
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    function formatSize(bytes){
      if(!bytes) return '-';
      if(bytes < 1024) return bytes + ' B';
      if(bytes < 1024*1024) return (bytes/1024).toFixed(1)+' KB';
      return (bytes/1024/1024).toFixed(1)+' MB';
    }

    // ********* API helpers *********

// GET helper (reads) — uses simple GET
async function apiGet() {
  const res = await fetch(API);
  const txt = await res.text();
  try { return JSON.parse(txt); } catch(e) { return { success:false, raw: txt }; }
}

// POST helper (form-encoded) — avoids preflight by sending application/x-www-form-urlencoded
async function apiPost(payload) {
  // payload is an object -> convert to URLSearchParams (simple request, no custom headers)
  const form = new URLSearchParams();
  for (const k in payload) {
    if (payload[k] === undefined || payload[k] === null) continue;
    form.append(k, String(payload[k]));
  }
  const res = await fetch(API, {
    method: 'POST',
    body: form // browser sends application/x-www-form-urlencoded automatically
  });
  const txt = await res.text();
  try { return JSON.parse(txt); } catch(e) { return { success:false, raw: txt }; }
}


    // ********* UI state *********
    let editingId = null;
    const tbody = document.getElementById('tbody');

    // ********* Render *********
    function renderRows(list){
      tbody.innerHTML = '';
      list.forEach(row=>{
        // our row fields: srNo, task, assignee, priority, status, start, end, estHrs, progress, file
        const tr = document.createElement('tr');
        const fileCell = row.file ? `<a href="${escapeHtml(row.file)}" target="_blank">Open</a>` : '-';
        tr.innerHTML = `
          <td data-label="Sr.No.">${escapeHtml(row.srNo)}</td>
          <td data-label="Task">${escapeHtml(row.task)}</td>
          <td data-label="Assignee">${escapeHtml(row.assignee)}</td>
          <td data-label="Priority">${escapeHtml(row.priority)}</td>
          <td data-label="Status"><span class="tag ${row.status==='Open'?'open':row.status==='In Progress'?'progress':'done'}">${escapeHtml(row.status)}</span></td>
          <td data-label="Start">${escapeHtml(row.start||'-')}</td>
          <td data-label="End">${escapeHtml(row.end||'-')}</td>
          <td data-label="Est Hrs">${escapeHtml(row.estHrs||0)}</td>
          <td data-label="Progress">
            <div class="flex">
              <div class="progressbar" title="${escapeHtml(String(row.progress||0))}%"><div class="progress-inner" style="width:${Number(row.progress||0)}%"></div></div>
              <div class="small">${escapeHtml(String(row.progress||0))}%</div>
            </div>
          </td>
          <td data-label="File">${fileCell}</td>
          <td class="actions">
            <button onclick="startEdit('${escapeHtml(row.srNo)}')">Edit</button>
            <button onclick="deleteTaskHandler('${escapeHtml(row.srNo)}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ********* Load tasks from server *********
    async function loadTasks(){
      try {
        const res = await apiFetch('GET');
        if (!res || !res.success) {
          console.error('Load tasks failed', res);
          return;
        }
        // res.data is array of rows as returned by Apps Script
        const mapped = (res.data||[]).map(r => ({
          srNo: r.srNo,
          task: r.task,
          assignee: r.assignee,
          priority: r.priority,
          status: r.status,
          start: r.start,
          end: r.end,
          estHrs: r.estHrs,
          progress: r.progress,
          file: r.file || ''
        }));
        renderRows(mapped);
      } catch (err) {
        console.error('loadTasks error', err);
      }
    }

    // ********* Create task (POST) *********
  async function createTaskOnServer(row) {
  const payload = Object.assign({}, row, { action: 'create' });
  const res = await apiPost(payload);
  return res && res.success;
}

    // ********* Update task (PUT) *********
    async function updateTaskOnServer(row) {
  const payload = Object.assign({}, row, { action: 'update', srNo: row.srNo || row.id || editingId });
  const res = await apiPost(payload);
  return res && res.success;
}


    // ********* Delete (DELETE) *********
    async function deleteTaskOnServer(srNo) {
  const res = await apiPost({ action: 'delete', srNo: srNo });
  return res && res.success;
}


    // ********* Upload file to Drive via server *********
    async function uploadFileToDrive(file, uploaderName) {
  return new Promise((resolve, reject) => {
    if (!file) return resolve(null);
    const reader = new FileReader();
    reader.onload = async function(e) {
      const dataUri = e.target.result; // data:<mime>;base64,.....
      const payload = {
        action: "uploadFile",
        name: file.name,
        mimeType: file.type || "application/octet-stream",
        size: file.size,
        base64: dataUri,
        uploader: uploaderName || ''
      };
      try {
        const res = await apiPost(payload);
        if (res && res.success) resolve(res.driveUrl || null);
        else reject(res);
      } catch (err) {
        reject(err);
      }
    };
    reader.onerror = (err) => reject(err);
    reader.readAsDataURL(file);
  });
}

    // ********* UI wiring *********
    document.getElementById('refreshBtn').addEventListener('click', loadTasks);
    document.getElementById('addBtn').addEventListener('click', ()=>openForm());
    document.getElementById('cancelForm').addEventListener('click', closeForm);
    document.getElementById('saveForm').addEventListener('click', saveFormToServer);

    // search + filter
    document.getElementById('search').addEventListener('input', applyFiltersLocal);
    document.getElementById('filterStatus').addEventListener('change', applyFiltersLocal);
    let lastLoadedList = [];

    function applyFiltersLocal(){
      const q = document.getElementById('search').value.toLowerCase();
      const status = document.getElementById('filterStatus').value;
      let list = lastLoadedList.slice();
      if (status !== 'all') list = list.filter(r => (r.status||'').toLowerCase() === status.toLowerCase());
      if (q) list = list.filter(r => (r.task+' '+r.assignee+' '+(r.file||'')).toLowerCase().includes(q));
      renderRows(list);
    }

    // open/close form
    function openForm(id){
      editingId = id || null;
      document.getElementById('formTitle').textContent = id ? 'Edit Task' : 'Add Task';
      // clear values
      document.getElementById('fTask').value = '';
      document.getElementById('fAssignee').value = '';
      document.getElementById('fPriority').value = 'Medium';
      document.getElementById('fStatus').value = 'Open';
      document.getElementById('fStart').value = '';
      document.getElementById('fEnd').value = '';
      document.getElementById('fHrs').value = '';
      document.getElementById('fProg').value = '';
      document.getElementById('taskFileInput').value = '';

      if (id) {
        // populate from lastLoadedList
        const found = lastLoadedList.find(x => String(x.srNo) === String(id));
        if (found) {
          document.getElementById('fTask').value = found.task || '';
          document.getElementById('fAssignee').value = found.assignee || '';
          document.getElementById('fPriority').value = found.priority || 'Medium';
          document.getElementById('fStatus').value = found.status || 'Open';
          document.getElementById('fStart').value = found.start || '';
          document.getElementById('fEnd').value = found.end || '';
          document.getElementById('fHrs').value = found.estHrs || '';
          document.getElementById('fProg').value = found.progress || '';
        }
      }

      document.getElementById('formWrap').style.display = 'flex';
    }
    function closeForm(){ document.getElementById('formWrap').style.display = 'none'; editingId = null; }

    async function saveFormToServer(){
      const row = {
        task: document.getElementById('fTask').value.trim(),
        assignee: document.getElementById('fAssignee').value.trim(),
        priority: document.getElementById('fPriority').value,
        status: document.getElementById('fStatus').value,
        start: document.getElementById('fStart').value,
        end: document.getElementById('fEnd').value,
        estHrs: Number(document.getElementById('fHrs').value) || 0,
        progress: Number(document.getElementById('fProg').value) || 0,
        file: ''
      };

      if (!row.task) { alert('Task title required'); return; }

      // optional file upload
      const fileInput = document.getElementById('taskFileInput');
      if (fileInput && fileInput.files && fileInput.files[0]) {
        try {
          const driveUrl = await uploadFileToDrive(fileInput.files[0], row.assignee || '');
          row.file = driveUrl || '';
        } catch(err) {
          console.error('file upload error', err);
          alert('File upload failed — check console');
          return;
        }
      }

      if (editingId) {
        row.srNo = editingId;
        const ok = await updateTaskOnServer(row);
        if (ok) { closeForm(); await loadTasks(); }
        else alert('Update failed — check console');
      } else {
        const ok = await createTaskOnServer(row);
        if (ok) { closeForm(); await loadTasks(); }
        else alert('Create failed — check console');
      }
    }

    // for Edit buttons
    window.startEdit = function(id){
      openForm(id);
    };

    // delete action
    window.deleteTaskHandler = async function(id){
      if (!confirm('Delete this task?')) return;
      const ok = await deleteTaskOnServer(id);
      if (ok) await loadTasks();
      else alert('Delete failed');
    };

    // initial load and polling
    async function fullLoad(){
      try {
        const res = await apiGet();
        if (res && res.success) {
          lastLoadedList = (res.data || []).map(r => ({
            srNo: r.srNo,
            task: r.task,
            assignee: r.assignee,
            priority: r.priority,
            status: r.status,
            start: r.start,
            end: r.end,
            estHrs: r.estHrs,
            progress: r.progress,
            file: r.file || ''
          }));
          renderRows(lastLoadedList);
        } else {
          console.error('Initial load failed', res);
        }
      } catch (err) {
        console.error('fullLoad error', err);
      }
    }

    // alias used earlier by loadTasks
    async function loadTasks(){ await fullLoad(); }

    // initial
    fullLoad();
    setInterval(loadTasks, POLL_MS);

    // accessibility: close form on ESC
    document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeForm(); });
  </script>
</body>
</html>
