<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Work-wise Table — Shared (Google Sheets)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa3b2;--accent:#0ea5a6;--accent-2:#7c3aed}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;background:linear-gradient(180deg,#071226 0%, #071a2b 100%);color:#e6eef6;min-height:100vh;padding:28px}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:10px;align-items:center}
    .controls input[type=text], .controls select{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .card{background:rgba(255,255,255,0.02);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.5)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
    th{cursor:pointer;user-select:none}
    tr:hover td{background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .tag.open{background:rgba(14,165,166,0.12);color:var(--accent)}
    .tag.progress{background:rgba(124,58,237,0.12);color:var(--accent-2)}
    .tag.done{background:rgba(34,197,94,0.12);color:#22c55e}
    .actions button{margin-right:6px;padding:6px 8px;border-radius:8px;border:none;background:rgba(255,255,255,0.02);color:inherit;cursor:pointer}
    .small{font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .progressbar{height:8px;background:rgba(255,255,255,0.04);border-radius:6px;overflow:hidden;width:120px}
    .progress-inner{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));}
    /* responsive */
    @media (max-width:800px){
      table thead{display:none}
      table,tbody,tr,td{display:block;width:100%}
      tr{margin-bottom:12px}
      td{padding:10px;border-bottom:0;background:rgba(255,255,255,0.02)}
      td:before{content:attr(data-label);display:block;font-weight:600;color:var(--muted);margin-bottom:6px}
    }

    /* Modal */
    #formWrap{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);align-items:center;justify-content:center;z-index:60}
    #formBox{background:var(--card);padding:18px;border-radius:12px;min-width:320px;max-width:640px;margin:auto}
    #formBox h3{margin:0 0 8px 0}
    #formBox .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
    #formBox input,#formBox select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Work-wise Table (Shared)</h1>
      <div class="controls">
        <input id="search" type="text" placeholder="Search tasks, assignee or notes" />
        <select id="filterStatus">
          <option value="all">All status</option>
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="Done">Done</option>
        </select>
        <button class="btn" id="addBtn">+ Add Task</button>
        <button class="btn ghost" id="refreshBtn">Refresh</button>
      </div>
    </header>

    <section class="card">
      <div class="small">Shared database: all users see the same data. Changes sync every 5s (or press Refresh).</div>

      <table id="workTable" aria-label="Work wise table">
        <thead>
          <tr>
            <th data-key="srNo">Sr.No.</th>
            <th data-key="task">Task</th>
            <th data-key="assignee">Assignee</th>
            <th data-key="priority">Priority</th>
            <th data-key="status">Status</th>
            <th data-key="start">Start</th>
            <th data-key="end">End</th>
            <th data-key="hrs">Est Hrs</th>
            <th data-key="prog">Progress</th>
            <th data-key="file">File</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </section>
  </div>

  <!-- hidden form -->
  <div id="formWrap">
    <div id="formBox">
      <h3 id="formTitle">Add Task</h3>
      <div class="row">
        <input id="fTask" placeholder="Task title" />
        <input id="fAssignee" placeholder="Assignee" />
      </div>
      <div class="row">
        <select id="fPriority"><option>Low</option><option>Medium</option><option>High</option></select>
        <select id="fStatus"><option>Open</option><option>In Progress</option><option>Done</option></select>
      </div>
      <div class="row">
        <input id="fStart" type="date" />
        <input id="fEnd" type="date" />
      </div>
      <div class="row">
        <input id="fHrs" placeholder="Estimated hours" type="number" />
        <input id="fProg" placeholder="Progress %" type="number" max="100" min="0" />
      </div>

      <!-- optional file input for attaching a file to a task -->
      <div style="margin-bottom:8px">
        <label class="small">Attach file (optional)</label><br>
        <input id="taskFileInput" type="file" />
      </div>

      <div style="text-align:right">
        <button id="cancelForm" style="margin-right:8px;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent">Cancel</button>
        <button id="saveForm" class="btn">Save</button>
      </div>
    </div>
  </div>

  <script>

// ========================
// 1. SET API URL
// ========================
const API = "https://script.google.com/macros/s/AKfycbxeQtXbnghWf8YYrY3ytShl_SLqI_XDmfwBgIWro2l81soPo-1OBFYeJRdVWcmDwMYu/exec";

// ========================
// 2. API WRAPPERS
// ========================
async function apiGet() {
  const url = `${API}?action=read`;
  const r = await fetch(url);
  return await r.json();
}

async function apiPost(payload) {
  const r = await fetch(API, {
    method: 'POST',
    body: JSON.stringify(payload),
    headers: { 'Content-Type': 'application/json' }
  });
  return await r.json();
}

async function apiDelete(srNo) {
  const url = `${API}?action=delete&srNo=${srNo}`;
  const r = await fetch(url, { method: 'POST' });
  return await r.json();
}

// ========================
// 3. LOAD ALL TASKS
// ========================
async function loadTasks() {
  try {
    const res = await apiGet();   // FIXED HERE ✔

    if (!res || !res.success) {
      console.error('Load tasks failed', res);
      return;
    }

    const tasks = (res.data || []).map(r => ({
      srNo: r.srNo,
      task: r.task,
      assignee: r.assignee,
      priority: r.priority,
      status: r.status,
      start: r.start,
      end: r.end,
      estHrs: r.estHrs,
      progress: r.progress,
      file: r.file || ''
    }));

    renderRows(tasks);

  } catch (err) {
    console.error("loadTasks error", err);
  }
}

// ========================
// 4. RENDER TABLE ROWS
// ========================
function renderRows(data) {
  const tbody = document.getElementById("taskBody");
  tbody.innerHTML = "";

  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.srNo}</td>
      <td>${row.task}</td>
      <td>${row.assignee}</td>
      <td>${row.priority}</td>
      <td>${row.status}</td>
      <td>${row.start}</td>
      <td>${row.end}</td>
      <td>${row.estHrs}</td>
      <td>${row.progress}%</td>
      <td><a href="${row.file}" target="_blank">File</a></td>
      <td>
        <button onclick="editTask(${row.srNo})">Edit</button>
        <button onclick="removeTask(${row.srNo})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ========================
// 5. SAVE / CREATE TASK
// ========================
async function saveFormToServer() {
  const data = {
    action: "write",
    srNo: document.getElementById("srNo").value,
    task: document.getElementById("task").value,
    assignee: document.getElementById("assignee").value,
    priority: document.getElementById("priority").value,
    status: document.getElementById("status").value,
    start: document.getElementById("start").value,
    end: document.getElementById("end").value,
    estHrs: document.getElementById("estHrs").value,
    progress: document.getElementById("progress").value,
    file: document.getElementById("file").value
  };

  const res = await apiPost(data);

  if (res.success) {
    alert("Saved successfully!");
    loadTasks();
  } else {
    alert("Save failed.");
  }
}

// ========================
// 6. DELETE TASK
// ========================
async function removeTask(srNo) {
  if (!confirm("Delete this task?")) return;

  const res = await apiDelete(srNo);
  if (res.success) {
    alert("Deleted!");
    loadTasks();
  }
}

// ========================
// 7. INITIAL LOAD
// ========================
async function fullLoad() {
  try {
    await loadTasks();
  } catch (err) {
    console.error("fullLoad error", err);
  }
}

document.addEventListener("DOMContentLoaded", fullLoad);

// Auto refresh every 60 sec
setInterval(loadTasks, 60000);

</script>
</body>
</html>
